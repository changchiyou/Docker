[
  {
    "id": "powerpoint_generator",
    "user_id": "29cdb3f9-ffa8-4978-9f0d-784a2796a858",
    "name": "Powerpoint Generator",
    "content": "\"\"\"\ntitle: Powerpoint Generator\ndescription: Generate powerpoint with user's input queue and provide download links\nauthor: changchiyou\nauthor_url: https://github.com/changchiyou\nfunding_url: https://github.com/open-webui\nversion: 0.0.1\nicon_url: data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4KPCEtLSBVcGxvYWRlZCB0bzogU1ZHIFJlcG8sIHd3dy5zdmdyZXBvLmNvbSwgR2VuZXJhdG9yOiBTVkcgUmVwbyBNaXhlciBUb29scyAtLT4KPHN2ZyB3aWR0aD0iODAwcHgiIGhlaWdodD0iODAwcHgiIHZpZXdCb3g9IjAgMCAyNCAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8dGl0bGU+bWljcm9zb2Z0X3Bvd2VycG9pbnQ8L3RpdGxlPgogIDxyZWN0IHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgZmlsbD0ibm9uZSIvPgogIDxwYXRoIGQ9Ik0xNCw1VjcuNzhBMywzLDAsMCwxLDE2LDd2M2gzYTMsMywwLDAsMS01LDIuMjJWMTRoNnYxSDE0djFoNnYxSDE0djJoOFY1Wm0zLDRWNmEzLDMsMCwwLDEsMywzWiIvPgogIDxnPgogICAgPHBhdGggZD0iTTIsNC44VjE5LjIxTDE0LDIxVjMuMDhaTTkuNiwxMi42MWEzLjQsMy40LDAsMCwxLTIuNS43MmwtLjg5LDB2My4zNGwtMS40LS4xOFY3Ljg5TDcuMjcsNy42YTMuMTEsMy4xMSwwLDAsMSwyLjQxLjQ3LDIuNzEsMi43MSwwLDAsMSwuOCwyLjE3QTMsMywwLDAsMSw5LjYsMTIuNjFaIi8+CiAgICA8cGF0aCBkPSJNNy4xOCw4Ljg2bC0xLC4wOHYzLjE0SDdhMi40MywyLjQzLDAsMCwwLDEuNTgtLjQxQTEuNjEsMS42MSwwLDAsMCw5LDEwLjM1YTEuNDgsMS40OCwwLDAsMC0uNDUtMS4yQTEuOTQsMS45NCwwLDAsMCw3LjE4LDguODZaIi8+CiAgPC9nPgo8L3N2Zz4=\n\"\"\"\n\nfrom pydantic import BaseModel, Field\nfrom typing import Optional, Dict, Any\nimport os\nfrom apps.webui.models.files import Files\nimport uuid\nimport logging\nimport time\nimport textwrap\nimport requests\nimport asyncio\n\n\n# Set up logging\nlogging.basicConfig(level=logging.DEBUG)\nlogger = logging.getLogger(__name__)\n\nclass FileData(BaseModel):\n    id: str\n    filename: str\n    meta: Dict[str, Any]\n\n\nclass Action:\n    class Valves(BaseModel):\n        show_status: bool = Field(\n            default=True, description=\"Show status of the action.\"\n        )\n        serviceAddress: str = Field(\n            default=\"http://192.168.63.122\", description=\"The address of powerpoint-generater service.\"\n        )\n        servicePort: str = Field(\n            default=\"5001\", description=\"The port number of powerpoint-generater service.\"\n        )\n        PPT_SECRET_KEY: str = Field(\n            default=\"\", description=\"The secret key for ppt flask app.\"\n        )\n\n    def __init__(self):\n        self.valves = self.Valves()\n        self.filename = \"\"\n\n    def create_or_get_file(self, user_id: str, json_data: str) -> str:\n        directory = \"action_embed\"\n\n        logger.debug(f\"Attempting to create or get file: {self.filename}.html\")\n\n        # Check if the file already exists\n        existing_files = Files.get_files()\n        for file in existing_files:\n            if (\n                file.filename == f\"{directory}/{user_id}/{self.filename}.html\"\n                and file.user_id == user_id\n            ):\n                logger.debug(\"Existing file found. Updating content.\")\n                # Update the existing file with new JSON data\n                self.update_html_content(file.meta[\"path\"], json_data)\n                return file.id\n\n        # If the file doesn''t exist, create it\n        base_path = os.path.join(\"uploads\", directory)\n        os.makedirs(base_path, exist_ok=True)\n        file_path = os.path.join(base_path, f\"{self.filename}.html\")\n\n        logger.debug(f\"Creating new file at: {file_path}\")\n        self.update_html_content(file_path, json_data)\n\n        file_id = str(uuid.uuid4())\n        meta = {\n            \"source\": file_path,\n            \"title\": \"Powerpoint Generator\",\n            \"content_type\": \"text/html\",\n            \"size\": os.path.getsize(file_path),\n            \"path\": file_path,\n        }\n\n        # Create a new file entry\n        file_data = FileData(\n            id=file_id, filename=f\"{directory}/{user_id}/{self.filename}.html\", meta=meta\n        )\n        new_file = Files.insert_new_file(user_id, file_data)\n        logger.debug(f\"New file created with ID: {new_file.id}\")\n        return new_file.id\n\n    def update_html_content(self, file_path: str, html_content: str):\n        with open(file_path, \"w\", encoding=\"utf-8\") as f:\n            f.write(html_content)\n        logger.debug(f\"HTML content updated at: {file_path}\")\n\n    def format_size(self, size_in_bytes):\n        \"\"\"Convert bytes to a human-readable format (KB, MB, GB, etc.).\"\"\"\n        if size_in_bytes == 0:\n            return \"0 Bytes\"\n\n        size_units = [\"Bytes\", \"KB\", \"MB\", \"GB\", \"TB\"]\n        index = 0\n\n        while size_in_bytes >= 1024 and index < len(size_units) - 1:\n            size_in_bytes /= 1024.0\n            index += 1\n\n        return f\"{size_in_bytes:.1f} {size_units[index]}\"\n\n    def get_file_size(self, filename):\n        try:\n            response = requests.get(f\"http://ppt:5001/file_size/{filename}\")\n            response.raise_for_status()  # Raise an error for bad responses\n\n            data = response.json()\n            size_in_bytes = data.get(\"size_in_bytes\")\n\n            # Format the size\n            formatted_size = self.format_size(size_in_bytes)\n\n            return formatted_size\n\n        except requests.exceptions.RequestException as e:\n            logger.debug(f\"Error retrieving file size: {e}\")\n\n\n    async def action(\n        self,\n        body: dict,\n        __user__=None,\n        __event_emitter__=None,\n        __event_call__=None,\n    ) -> Optional[dict]:\n        logger.debug(f\"action:{__name__} started\")\n\n        if __event_emitter__ and __event_call__ and __user__:\n            presentation_title = await __event_call__(\n                {\n                    \"type\": \"input\",\n                    \"data\": {\n                        \"title\": \"Write down your presentation title\",\n                        \"message\": \"The title would be placed at the first page of powerpoint\",\n                        \"placeholder\": \"Enter your title here\",\n                    },\n                }\n            )\n            await asyncio.sleep(1)\n\n            await __event_emitter__(\n                {\n                    \"type\": \"status\",\n                    \"data\": {\n                        \"description\": \"Generating Powerpoint\",\n                        \"done\": False,\n                    },\n                }\n            )\n            await asyncio.sleep(1)\n\n            try:\n                user_id = __user__[\"id\"]\n                user_name = __user__[\"name\"]\n\n                self.filename = f\"{presentation_title.replace(' ', '_')}-{str(int(time.time() * 1000))}\"\n\n                data = {\n                    'number_of_slide': -1,\n                    'user_text': body[\"messages\"][-1][\"content\"],\n                    'presentation_title': presentation_title,\n                    'presenter_name': user_name,\n                    'filename': self.filename,\n                }\n                requests.post(\n                    f\"http://ppt:{self.valves.servicePort}/generator\",\n                    data=data,\n                    headers={\"Authorization\": f\"Bearer {self.valves.PPT_SECRET_KEY}\"},\n                )\n\n                html_content = textwrap.dedent(f\"\"\"\n                <!DOCTYPE html>\n                    <html lang=\"en\">\n                    <head>\n                        <meta charset=\"UTF-8\">\n                        <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n                        <title>Download File</title>\n                        <style>\n                            body {{\n                                font-family: Arial, sans-serif;\n                                display: flex;\n                                justify-content: center;\n                                align-items: center;\n                                height: 100vh;\n                                margin: 0;\n                                background-color: #f0f0f0;\n                            }}\n                            .download-button {{\n                                display: flex;\n                                align-items: center;\n                                background-color: #2c2c2c;\n                                color: #ffffff;\n                                padding: 10px 15px;\n                                border-radius: 5px;\n                                cursor: pointer;\n                                transition: background-color 0.3s;\n                            }}\n                            .download-button:hover {{\n                                background-color: #3a3a3a;\n                            }}\n                            .icon {{\n                                width: 20px;\n                                height: 20px;\n                                margin-right: 10px;\n                                background-color: #ffffff;\n                                mask: url(\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z'/%3E%3C/svg%3E\") no-repeat center / contain;\n                                -webkit-mask: url(\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z'/%3E%3C/svg%3E\") no-repeat center / contain;\n                            }}\n                            .file-info {{\n                                display: flex;\n                                flex-direction: column;\n                            }}\n                            .file-name {{\n                                font-weight: bold;\n                            }}\n                            .file-meta {{\n                                font-size: 0.8em;\n                                opacity: 0.7;\n                            }}\n                        </style>\n                    </head>\n                    <body>\n                        <div class=\"download-button\" onclick=\"downloadFile()\">\n                            <div class=\"icon\"></div>\n                            <div class=\"file-info\">\n                                <span class=\"file-name\">{self.filename}.pptx</span>\n                                <span class=\"file-meta\">File {self.get_file_size(self.filename+'.pptx')}</span>\n                            </div>\n                        </div>\n\n                        <script>\n                            function downloadFile() {{\n                                const filename = '{self.filename}.pptx';\n                                const serviceAddress = '{self.valves.serviceAddress}';\n                                const servicePort = '{self.valves.servicePort}';\n                                const downloadUrl = `${{serviceAddress}}:${{servicePort}}/download/${{filename}}`;\n                                \n                                fetch(downloadUrl)\n                                    .then(response => {{\n                                        if (response.ok) {{\n                                            return response.blob();\n                                        }}\n                                        throw new Error('Network response was not ok.');\n                                    }})\n                                    .then(blob => {{\n                                        const url = window.URL.createObjectURL(blob);\n                                        const a = document.createElement('a');\n                                        a.style.display = 'none';\n                                        a.href = url;\n                                        a.download = filename;\n                                        document.body.appendChild(a);\n                                        a.click();\n                                        window.URL.revokeObjectURL(url);\n                                    }})\n                                    .catch(error => {{\n                                        console.error('There was a problem with the download:', error);\n                                        alert('下載過程中發生了意外狀況，可能因為定期清除流程導致檔案已被刪除、可嘗試重新產生一份 PowerPoint 並重新點擊下載連結。若多次嘗試後還是沒能成功下載，請聯絡開發人員。');\n                                    }});\n                            }}\n                        </script>\n                    </body>\n                    </html>\n                \"\"\")\n\n                file_id = self.create_or_get_file(user_id, html_content)\n\n                # Create the HTML embed tag\n                html_embed_tag = f\"{{{{HTML_FILE_ID_{file_id}}}}}\"\n\n                # Append the HTML embed tag to the original content on a new line\n                original_content = body[\"messages\"][-1][\"content\"]\n                body[\"messages\"][-1][\n                    \"content\"\n                ] = f\"{original_content}\\n\\n{html_embed_tag}\"\n\n                await __event_emitter__(\n                    {\n                        \"type\": \"status\",\n                        \"data\": {\n                            \"description\": \"Powerpoint generated\",\n                            \"done\": True,\n                        },\n                    }\n                )\n\n                logger.debug(\"Action done successfully.\")\n\n            except Exception as e:\n                error_message = f\"Error generating powerpoint: {str(e)}\"\n                logger.error(f\"Error: {error_message}\")\n\n                if self.valves.show_status:\n                    await __event_emitter__(\n                        {\n                            \"type\": \"status\",\n                            \"data\": {\n                                \"description\": \"⚠️ Error Generating Powerpoint\",\n                                \"done\": True,\n                            },\n                        }\n                    )\n        else:\n            logger.error(f\"__user__: {__user__}\")\n            logger.error(f\"__event_emitter__: {__event_emitter__}\")\n            logger.error(f\"__event_call__: {__event_call__}\")\n\n        logger.debug(f\"action:{__name__} completed\")\n        return body",
    "meta": {
      "description": "Generate powerpoint with user's input queue and provide download links",
      "manifest": {
        "title": "Powerpoint Generator",
        "description": "Generate powerpoint with user's input queue and provide download links",
        "author": "changchiyou",
        "author_url": "https://github.com/changchiyou",
        "funding_url": "https://github.com/open-webui",
        "version": "0.0.1",
        "icon_url": "data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4KPCEtLSBVcGxvYWRlZCB0bzogU1ZHIFJlcG8sIHd3dy5zdmdyZXBvLmNvbSwgR2VuZXJhdG9yOiBTVkcgUmVwbyBNaXhlciBUb29scyAtLT4KPHN2ZyB3aWR0aD0iODAwcHgiIGhlaWdodD0iODAwcHgiIHZpZXdCb3g9IjAgMCAyNCAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8dGl0bGU+bWljcm9zb2Z0X3Bvd2VycG9pbnQ8L3RpdGxlPgogIDxyZWN0IHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgZmlsbD0ibm9uZSIvPgogIDxwYXRoIGQ9Ik0xNCw1VjcuNzhBMywzLDAsMCwxLDE2LDd2M2gzYTMsMywwLDAsMS01LDIuMjJWMTRoNnYxSDE0djFoNnYxSDE0djJoOFY1Wm0zLDRWNmEzLDMsMCwwLDEsMywzWiIvPgogIDxnPgogICAgPHBhdGggZD0iTTIsNC44VjE5LjIxTDE0LDIxVjMuMDhaTTkuNiwxMi42MWEzLjQsMy40LDAsMCwxLTIuNS43MmwtLjg5LDB2My4zNGwtMS40LS4xOFY3Ljg5TDcuMjcsNy42YTMuMTEsMy4xMSwwLDAsMSwyLjQxLjQ3LDIuNzEsMi43MSwwLDAsMSwuOCwyLjE3QTMsMywwLDAsMSw5LjYsMTIuNjFaIi8+CiAgICA8cGF0aCBkPSJNNy4xOCw4Ljg2bC0xLC4wOHYzLjE0SDdhMi40MywyLjQzLDAsMCwwLDEuNTgtLjQxQTEuNjEsMS42MSwwLDAsMCw5LDEwLjM1YTEuNDgsMS40OCwwLDAsMC0uNDUtMS4yQTEuOTQsMS45NCwwLDAsMCw3LjE4LDguODZaIi8+CiAgPC9nPgo8L3N2Zz4="
      }
    },
    "updated_at": 1728494953,
    "created_at": 1728366910,
    "is_active": true,
    "is_global": true
  }
]